<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>One-OS Field Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #070b10;
      --bg-soft: #0c1118;
      --panel: #101722;
      --panel-soft: #151d2a;
      --accent: #4f9cff;
      --accent-soft: rgba(79, 156, 255, 0.18);
      --accent-strong: #8ad0ff;
      --text-main: #f5f7ff;
      --text-soft: #a4b0c4;
      --border-subtle: #1e2633;
      --radius-lg: 22px;
      --radius-md: 14px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --shadow-subtle: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151f33 0, #05070b 55%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      min-height: 100vh;
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    /* Top nav */

    .top-nav {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px 8px;
      background: linear-gradient(
        to bottom,
        rgba(3, 7, 13, 0.96),
        rgba(3, 7, 13, 0.88),
        rgba(3, 7, 13, 0.78),
        transparent
      );
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }

    .top-nav-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .back-btn {
      border: none;
      background: rgba(11, 18, 30, 0.9);
      color: var(--text-soft);
      border-radius: 999px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 15px;
      box-shadow: var(--shadow-subtle);
      outline: none;
      transition: background 0.12s ease, transform 0.12s ease,
        box-shadow 0.12s ease;
    }

    .back-btn span {
      display: inline-flex;
      transform: translateY(-0.5px);
    }

    .back-btn:hover {
      background: rgba(22, 30, 46, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.7);
    }

    .back-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-subtle);
    }

    .back-btn[disabled] {
      opacity: 0.23;
      cursor: default;
      box-shadow: none;
    }

    .breadcrumb {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }

    .crumb {
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(11, 18, 30, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.03);
      color: var(--text-soft);
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease,
        border-color 0.12s ease;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .crumb.current {
      background: linear-gradient(
        135deg,
        rgba(79, 156, 255, 0.22),
        rgba(105, 220, 255, 0.24)
      );
      border-color: rgba(163, 210, 255, 0.55);
      color: var(--text-main);
      cursor: default;
    }

    .crumb:not(.current):hover {
      background: rgba(20, 29, 46, 0.96);
      color: var(--accent-strong);
      border-color: rgba(125, 175, 255, 0.6);
    }

    .crumb-separator {
      color: rgba(132, 149, 180, 0.55);
      font-size: 13px;
    }

    /* Main */

    main {
      flex: 1;
      padding: 12px 14px 82px;
    }

    @media (min-width: 720px) {
      main {
        padding: 18px 20px 90px;
      }
    }

    /* Panels */

    .panel {
      background: radial-gradient(circle at top left, #1c2941, #0a0f18);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      box-shadow: var(--shadow-soft);
    }

    .panel-soft {
      background: radial-gradient(circle at top, #131b2b, #060911);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: var(--shadow-subtle);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    /* Lens */

    .lens-panel {
      margin-bottom: 14px;
    }

    .lens-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .select {
      position: relative;
      flex: 1;
      min-width: 120px;
    }

    .select select {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(9, 13, 20, 0.96);
      color: var(--text-main);
      font-size: 13px;
      appearance: none;
      outline: none;
    }

    .select-arrow {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-soft);
      pointer-events: none;
    }

    .lens-input {
      width: 100%;
      min-height: 50px;
      max-height: 160px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(3, 7, 16, 0.96);
      color: var(--text-main);
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 8px;
      outline: none;
    }

    .lens-input::placeholder {
      color: rgba(158, 171, 196, 0.7);
    }

    .lens-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .lens-hint {
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.85;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      outline: none;
      transition: background 0.1s ease, box-shadow 0.1s ease,
        transform 0.1s ease, color 0.1s ease, border-color 0.1s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f9cff, #7dd7ff);
      color: #05060a;
      box-shadow: 0 10px 26px rgba(16, 117, 255, 0.55);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5aa8ff, #95e3ff);
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(18, 132, 255, 0.72);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 26px rgba(16, 117, 255, 0.55);
    }

    .btn-ghost {
      background: rgba(5, 10, 18, 0.9);
      color: var(--accent-strong);
      border: 1px solid rgba(111, 167, 255, 0.45);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.7);
    }

    .btn-ghost:hover {
      background: rgba(13, 19, 32, 0.98);
      border-color: rgba(129, 192, 255, 0.85);
    }

    .btn-ghost:active {
      transform: translateY(0);
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      justify-content: center;
      padding: 0;
    }

    .btn[disabled] {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    /* Home field list */

    .home-fields {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-tile {
      background: linear-gradient(
        135deg,
        rgba(37, 56, 92, 0.98),
        rgba(12, 17, 27, 0.98)
      );
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      border: 1px solid rgba(163, 196, 255, 0.25);
      cursor: pointer;
      box-shadow: var(--shadow-subtle);
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease;
    }

    .field-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
      border-color: rgba(190, 214, 255, 0.8);
      background: linear-gradient(
        135deg,
        rgba(49, 79, 131, 0.98),
        rgba(16, 22, 38, 0.98)
      );
    }

    .field-tile-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .field-tile-meta {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .empty-message {
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-soft);
    }

    /* Field page */

    .field-page-header {
      margin-bottom: 12px;
    }

    .field-page-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin-bottom: 4px;
    }

    .field-page-meta {
      font-size: 12px;
      color: var(--text-soft);
    }

    .textarea-wrapper {
      position: relative;
      margin-top: 8px;
    }

    .textarea-main {
      width: 100%;
      min-height: 80px;
      max-height: 320px;
      resize: vertical;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: radial-gradient(circle at top left, #131b2b, #060811);
      color: var(--text-main);
      padding: 10px 11px;
      font-size: 13px;
      outline: none;
    }

    .textarea-main::placeholder {
      color: rgba(158, 171, 196, 0.72);
    }

    .textarea-resize-hint {
      position: absolute;
      right: 9px;
      bottom: 4px;
      font-size: 10px;
      color: rgba(148, 165, 196, 0.7);
    }

    .field-next-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
    }

    .field-next-hint {
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    /* Modules */

    .modules-section {
      margin-top: 12px;
    }

    .modules-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .modules-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .modules-count {
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.86;
    }

    .module-card {
      margin-top: 8px;
      background: radial-gradient(circle at top, #131b24, #05070d);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-subtle);
      overflow: hidden;
    }

    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      cursor: pointer;
    }

    .module-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .module-meta {
      font-size: 11px;
      color: var(--text-soft);
    }

    .module-chevron {
      font-size: 11px;
      color: var(--text-soft);
      margin-left: 6px;
      transition: transform 0.14s ease;
    }

    .module-chevron.expanded {
      transform: rotate(90deg);
    }

    .module-body {
      padding: 8px 10px 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .module-textarea {
      width: 100%;
      min-height: 70px;
      max-height: 260px;
      resize: vertical;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: radial-gradient(circle at top left, #131b26, #04060c);
      color: var(--text-main);
      padding: 8px 9px;
      font-size: 13px;
      outline: none;
    }

    .module-textarea::placeholder {
      color: rgba(148, 165, 196, 0.74);
    }

    .module-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .module-footer-hint {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Bottom nav */

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding: 9px 12px 10px;
      display: flex;
      justify-content: center;
      pointer-events: none;
    }

    .bottom-nav-inner {
      pointer-events: auto;
      max-width: 560px;
      width: 100%;
      margin: 0 auto;
      background: rgba(5, 8, 16, 0.96);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      gap: 4px;
    }

    .nav-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      padding: 7px 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      transition: background 0.12s ease, color 0.12s ease;
    }

    .nav-btn span.icon {
      font-size: 14px;
      display: inline-flex;
    }

    .nav-btn-active {
      background: radial-gradient(circle at top, #243552, #101727);
      color: var(--accent-strong);
    }

    .add-fab {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #4f9cff, #7dd7ff);
      color: #05060a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      outline: none;
      box-shadow: 0 16px 40px rgba(19, 128, 255, 0.9);
      transform: translateY(-8px);
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
    }

    .add-fab:hover {
      transform: translateY(-10px);
      box-shadow: 0 22px 50px rgba(26, 145, 255, 1);
    }

    .add-fab:active {
      transform: translateY(-6px);
      box-shadow: 0 14px 32px rgba(19, 128, 255, 0.85);
    }

    /* Misc */

    .chip {
      border-radius: 999px;
      font-size: 10px;
      padding: 3px 8px;
      background: rgba(41, 53, 82, 0.9);
      color: var(--text-soft);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top-nav">
      <button class="back-btn" id="backBtn">
        <span>&larr;</span>
      </button>
      <div class="breadcrumb" id="breadcrumb">
        <div class="top-nav-title">One-OS Field Engine</div>
      </div>
    </header>
    <main id="main"></main>

    <nav class="bottom-nav">
      <div class="bottom-nav-inner">
        <button class="nav-btn nav-btn-active" id="homeNav">
          <span class="icon">&#8962;</span>
          <span>Home</span>
        </button>
        <button class="add-fab" id="addBtn">+</button>
        <button class="nav-btn" id="placeholderNav">
          <span class="icon">&#9881;</span>
          <span>Core</span>
        </button>
      </div>
    </nav>
  </div>

  <script>
    // Simple id helper
    function uuid() {
      return (
        Date.now().toString(36) +
        Math.random().toString(36).substring(2, 8)
      ).toUpperCase();
    }

    const STORAGE_KEY = "oneos.branching.state.v1";

    const StorageLayer = {
      save(state) {
        try {
          const payload = JSON.stringify(state);
          localStorage.setItem(STORAGE_KEY, payload);
        } catch (e) {
          console.error("Failed to save state", e);
        }
      },
      load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          console.error("Failed to load state", e);
          return null;
        }
      },
    };

    const App = {
      state: {
        fields: [],
        currentFieldId: null,
        view: "home", // 'home' | 'field'
      },

      init() {
        const saved = StorageLayer.load();
        if (saved && Array.isArray(saved.fields)) {
          this.state = Object.assign(
            { fields: [], currentFieldId: null, view: "home" },
            saved
          );
        }
        this.cacheDom();
        this.attachNavHandlers();
        this.render();
      },

      cacheDom() {
        this.main = document.getElementById("main");
        this.breadcrumbEl = document.getElementById("breadcrumb");
        this.backBtn = document.getElementById("backBtn");
        this.homeNav = document.getElementById("homeNav");
        this.addBtn = document.getElementById("addBtn");
      },

      persist() {
        StorageLayer.save(this.state);
      },

      setView(view, fieldId = null) {
        this.state.view = view;
        if (view === "field") {
          this.state.currentFieldId = fieldId;
        } else {
          this.state.currentFieldId = null;
        }
        this.persist();
        this.render();
      },

      get currentField() {
        if (!this.state.currentFieldId) return null;
        return this.state.fields.find(
          (f) => f.id === this.state.currentFieldId
        );
      },

      get masterFields() {
        return this.state.fields.filter((f) => !f.parentFieldId);
      },

      getFieldById(id) {
        return this.state.fields.find((f) => f.id === id) || null;
      },

      updateField(updated) {
        const idx = this.state.fields.findIndex((f) => f.id === updated.id);
        if (idx !== -1) {
          this.state.fields[idx] = updated;
          this.persist();
        }
      },

      createMasterField() {
        const title = prompt("Name this field:");
        if (!title) return;
        const newField = {
          id: uuid(),
          title: title.trim(),
          description: "",
          descriptionBox: {
            height: 120,
          },
          parentFieldId: null,
          viaModuleId: null,
          nextFieldId: null,
          modules: [],
        };
        this.state.fields.push(newField);
        this.setView("field", newField.id);
      },

      createModule(fieldId) {
        const field = this.getFieldById(fieldId);
        if (!field) return;
        const title = prompt("Name this module:");
        if (!title) return;
        const module = {
          id: uuid(),
          title: title.trim(),
          text: "",
          box: {
            height: 100,
            expanded: true,
          },
        };
        field.modules.push(module);
        this.updateField(field);
        this.render();
      },

      createOrGoToNextField(fromFieldId, fromModuleId) {
        const field = this.getFieldById(fromFieldId);
        if (!field) return;

        if (field.nextFieldId) {
          this.setView("field", field.nextFieldId);
          return;
        }

        const module = field.modules.find((m) => m.id === fromModuleId);
        const baseTitle = module ? module.title : "Next";
        const title = prompt(
          "Name the next field in this chain:",
          baseTitle + " →"
        );
        if (!title) return;

        const newField = {
          id: uuid(),
          title: title.trim(),
          description: "",
          descriptionBox: {
            height: 120,
          },
          parentFieldId: field.id,
          viaModuleId: fromModuleId || null,
          nextFieldId: null,
          modules: [],
        };

        field.nextFieldId = newField.id;
        this.updateField(field);

        this.state.fields.push(newField);
        this.setView("field", newField.id);
      },

      handleLensSubmit() {
        const fieldSelect = document.getElementById("lensFieldSelect");
        const moduleSelect = document.getElementById("lensModuleSelect");
        const input = document.getElementById("lensInput");

        if (!fieldSelect || !moduleSelect || !input) return;

        const fieldId = fieldSelect.value;
        const moduleId = moduleSelect.value;
        const text = input.value.trim();
        if (!fieldId || !moduleId || !text) return;

        const field = this.getFieldById(fieldId);
        if (!field) return;
        const mod = field.modules.find((m) => m.id === moduleId);
        if (!mod) return;

        const stamp = new Date().toLocaleString();
        mod.text = (mod.text || "") + (mod.text ? "\n\n" : "") + "[" + stamp + "] " + text;
        this.updateField(field);
        input.value = "";
        this.render();
      },

      handleBack() {
        if (this.state.view === "home") return;
        const current = this.currentField;
        if (!current) {
          this.setView("home");
          return;
        }
        if (!current.parentFieldId) {
          this.setView("home");
          return;
        }
        this.setView("field", current.parentFieldId);
      },

      buildBreadcrumb() {
        const bc = this.breadcrumbEl;
        bc.innerHTML = "";

        if (this.state.view === "home") {
          const label = document.createElement("div");
          label.className = "top-nav-title";
          label.textContent = "Home · Fields";
          bc.appendChild(label);
          this.backBtn.disabled = true;
          return;
        }

        const chain = [];
        let node = this.currentField;
        while (node) {
          chain.unshift(node);
          if (!node.parentFieldId) break;
          node = this.getFieldById(node.parentFieldId);
        }

        chain.forEach((field, idx) => {
          if (idx > 0) {
            const sep = document.createElement("span");
            sep.className = "crumb-separator";
            sep.textContent = "›";
            bc.appendChild(sep);
          }
          const isCurrent = idx === chain.length - 1;
          const c = document.createElement("button");
          c.type = "button";
          c.className = "crumb" + (isCurrent ? " current" : "");
          c.textContent = field.title;
          if (!isCurrent) {
            c.addEventListener("click", () => {
              this.setView("field", field.id);
            });
          }
          bc.appendChild(c);
        });

        this.backBtn.disabled = chain.length <= 1;
      },

      attachNavHandlers() {
        this.homeNav.addEventListener("click", () => {
          this.homeNav.classList.add("nav-btn-active");
          this.setView("home");
        });

        this.addBtn.addEventListener("click", () => {
          if (this.state.view === "home") {
            this.createMasterField();
          } else if (this.state.view === "field" && this.currentField) {
            this.createModule(this.currentField.id);
          }
        });

        this.backBtn.addEventListener("click", () => {
          this.handleBack();
        });
      },

      render() {
        this.buildBreadcrumb();
        if (this.state.view === "home") {
          this.homeNav.classList.add("nav-btn-active");
          this.renderHome();
        } else {
          this.homeNav.classList.remove("nav-btn-active");
          this.renderField();
        }
      },

      renderHome() {
        const container = document.createElement("div");

        // Lens panel
        const lensPanel = document.createElement("div");
        lensPanel.className = "panel lens-panel";

        const header = document.createElement("div");
        header.className = "panel-header";
        const title = document.createElement("div");
        title.className = "panel-title";
        title.textContent = "Lens Router";
        const subtitle = document.createElement("div");
        subtitle.className = "panel-subtitle";
        subtitle.textContent = "Send thoughts into any module across the system.";
        header.appendChild(title);
        header.appendChild(subtitle);
        lensPanel.appendChild(header);

        const lensRow = document.createElement("div");
        lensRow.className = "lens-row";

        const selectFieldWrap = document.createElement("div");
        selectFieldWrap.className = "select";
        const fieldSelect = document.createElement("select");
        fieldSelect.id = "lensFieldSelect";

        const placeholderOption = document.createElement("option");
        placeholderOption.value = "";
        placeholderOption.textContent = this.state.fields.length
          ? "Choose field"
          : "No fields yet";
        fieldSelect.appendChild(placeholderOption);

        this.state.fields.forEach((f) => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.title;
          fieldSelect.appendChild(opt);
        });

        selectFieldWrap.appendChild(fieldSelect);
        const arrow1 = document.createElement("div");
        arrow1.className = "select-arrow";
        arrow1.textContent = "▾";
        selectFieldWrap.appendChild(arrow1);

        const selectModuleWrap = document.createElement("div");
        selectModuleWrap.className = "select";
        const moduleSelect = document.createElement("select");
        moduleSelect.id = "lensModuleSelect";

        const modulePlaceholder = document.createElement("option");
        modulePlaceholder.value = "";
        modulePlaceholder.textContent = "Choose module";
        moduleSelect.appendChild(modulePlaceholder);

        selectModuleWrap.appendChild(moduleSelect);
        const arrow2 = document.createElement("div");
        arrow2.className = "select-arrow";
        arrow2.textContent = "▾";
        selectModuleWrap.appendChild(arrow2);

        lensRow.appendChild(selectFieldWrap);
        lensRow.appendChild(selectModuleWrap);
        lensPanel.appendChild(lensRow);

        const lensInput = document.createElement("textarea");
        lensInput.id = "lensInput";
        lensInput.className = "lens-input";
        lensInput.placeholder =
          "Type a reflection, idea, instruction or note. It will be appended into the selected module.";
        lensPanel.appendChild(lensInput);

        const lensFooter = document.createElement("div");
        lensFooter.className = "lens-footer";
        const hint = document.createElement("div");
        hint.className = "lens-hint";
        hint.textContent =
          "Lens keeps structure light: choose where this thought should live, then keep moving.";
        const btn = document.createElement("button");
        btn.className = "btn btn-primary btn-small";
        btn.textContent = "Send to module";
        btn.addEventListener("click", () => this.handleLensSubmit());
        lensFooter.appendChild(hint);
        lensFooter.appendChild(btn);
        lensPanel.appendChild(lensFooter);

        container.appendChild(lensPanel);

        // Update module dropdown when field changes
        fieldSelect.addEventListener("change", () => {
          const fieldId = fieldSelect.value;
          moduleSelect.innerHTML = "";
          const baseOpt = document.createElement("option");
          baseOpt.value = "";
          baseOpt.textContent = "Choose module";
          moduleSelect.appendChild(baseOpt);

          if (!fieldId) return;
          const field = this.getFieldById(fieldId);
          if (!field) return;
          field.modules.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.textContent = m.title;
            moduleSelect.appendChild(opt);
          });
        });

        // Master field list
        const fieldsPanel = document.createElement("div");
        fieldsPanel.className = "panel-soft";
        const fieldsHeader = document.createElement("div");
        fieldsHeader.className = "panel-header";
        const fieldsTitle = document.createElement("div");
        fieldsTitle.className = "panel-title";
        fieldsTitle.textContent = "Fields";
        const fieldsSub = document.createElement("div");
        fieldsSub.className = "panel-subtitle";
        fieldsSub.textContent =
          "These are your top-level fields. Tap one to enter its chain.";
        fieldsHeader.appendChild(fieldsTitle);
        fieldsHeader.appendChild(fieldsSub);
        fieldsPanel.appendChild(fieldsHeader);

        const list = document.createElement("div");
        list.className = "home-fields";

        const masters = this.masterFields;
        if (!masters.length) {
          const msg = document.createElement("div");
          msg.className = "empty-message";
          msg.textContent =
            "No fields yet. Use the + button in the bottom bar to plant your first master field.";
          fieldsPanel.appendChild(msg);
        } else {
          masters.forEach((f) => {
            const tile = document.createElement("div");
            tile.className = "field-tile";
            tile.addEventListener("click", () => {
              this.setView("field", f.id);
            });

            const ttl = document.createElement("div");
            ttl.className = "field-tile-title";
            ttl.textContent = f.title;

            const metaRow = document.createElement("div");
            metaRow.className = "field-tile-meta";
            const modulesCount = document.createElement("span");
            modulesCount.textContent = `${f.modules.length} module${
              f.modules.length === 1 ? "" : "s"
            }`;

            let depth = 1;
            let cursor = f;
            while (cursor.nextFieldId) {
              const nf = this.getFieldById(cursor.nextFieldId);
              if (!nf) break;
              depth += 1;
              cursor = nf;
            }
            const depthSpan = document.createElement("span");
            depthSpan.textContent = `Chain depth: ${depth}`;

            metaRow.appendChild(modulesCount);
            metaRow.appendChild(depthSpan);

            tile.appendChild(ttl);
            tile.appendChild(metaRow);
            list.appendChild(tile);
          });
        }

        fieldsPanel.appendChild(list);
        fieldsPanel.style.marginTop = "12px";
        container.appendChild(fieldsPanel);

        this.main.innerHTML = "";
        this.main.appendChild(container);
      },

      renderField() {
        const field = this.currentField;
        if (!field) {
          this.setView("home");
          return;
        }

        const container = document.createElement("div");

        const headerBlock = document.createElement("div");
        headerBlock.className = "field-page-header";
        const title = document.createElement("div");
        title.className = "field-page-title";
        title.textContent = field.title;
        const meta = document.createElement("div");
        meta.className = "field-page-meta";
        const depth = this.computeDepth(field.id);
        meta.textContent = `Field · Depth ${depth} · ${
          field.modules.length
        } module${field.modules.length === 1 ? "" : "s"}`;
        headerBlock.appendChild(title);
        headerBlock.appendChild(meta);
        container.appendChild(headerBlock);

        const fieldPanel = document.createElement("div");
        fieldPanel.className = "panel";

        const fieldHeader = document.createElement("div");
        fieldHeader.className = "panel-header";
        const phTitle = document.createElement("div");
        phTitle.className = "panel-title";
        phTitle.textContent = "Field Description";
        const phSub = document.createElement("div");
        phSub.className = "panel-subtitle";
        phSub.textContent =
          "Describe what this field holds, what it connects, or how it should feel.";
        fieldHeader.appendChild(phTitle);
        fieldHeader.appendChild(phSub);
        fieldPanel.appendChild(fieldHeader);

        const textareaWrap = document.createElement("div");
        textareaWrap.className = "textarea-wrapper";
        const ta = document.createElement("textarea");
        ta.className = "textarea-main";
        ta.value = field.description || "";
        if (field.descriptionBox && field.descriptionBox.height) {
          ta.style.height = field.descriptionBox.height + "px";
        }
        ta.placeholder =
          "Example: This field tracks the core arc for this project / world / team. Use it as the spine, not the detail log.";
        ta.addEventListener("input", () => {
          field.description = ta.value;
          field.descriptionBox.height = ta.clientHeight;
          this.updateField(field);
        });

        textareaWrap.appendChild(ta);
        const resizeHint = document.createElement("div");
        resizeHint.className = "textarea-resize-hint";
        resizeHint.textContent = "drag to resize";
        textareaWrap.appendChild(resizeHint);
        fieldPanel.appendChild(textareaWrap);

        const nextRow = document.createElement("div");
        nextRow.className = "field-next-row";
        const nextHint = document.createElement("div");
        nextHint.className = "field-next-hint";
        nextHint.textContent =
          field.nextFieldId
            ? "Step into the next field in this chain."
            : "Use a module below to create the next field in this chain.";
        const nextBtn = document.createElement("button");
        nextBtn.className = "btn btn-ghost btn-small";
        nextBtn.textContent = field.nextFieldId
          ? "Go to next field"
          : "Next field (from module)";
        nextBtn.disabled = !field.nextFieldId;
        nextRow.appendChild(nextHint);
        nextRow.appendChild(nextBtn);
        fieldPanel.appendChild(nextRow);

        container.appendChild(fieldPanel);

        // Modules section
        const modulesPanel = document.createElement("div");
        modulesPanel.className = "modules-section";

        const modulesHeaderRow = document.createElement("div");
        modulesHeaderRow.className = "modules-header-row";
        const modulesTitle = document.createElement("div");
        modulesTitle.className = "modules-title";
        modulesTitle.textContent = "Modules in this field";
        const modulesCount = document.createElement("div");
        modulesCount.className = "modules-count";
        modulesCount.textContent = `${field.modules.length} module${
          field.modules.length === 1 ? "" : "s"
        }`;
        modulesHeaderRow.appendChild(modulesTitle);
        modulesHeaderRow.appendChild(modulesCount);
        modulesPanel.appendChild(modulesHeaderRow);

        if (!field.modules.length) {
          const msg = document.createElement("div");
          msg.className = "empty-message";
          msg.textContent =
            "No modules yet. Use the + button in the bottom bar to add a module inside this field.";
          modulesPanel.appendChild(msg);
        } else {
          field.modules.forEach((mod) => {
            const card = document.createElement("div");
            card.className = "module-card";

            const header = document.createElement("div");
            header.className = "module-header";

            const left = document.createElement("div");
            const mTitle = document.createElement("div");
            mTitle.className = "module-title";
            mTitle.textContent = mod.title;
            const mMeta = document.createElement("div");
            mMeta.className = "module-meta";
            mMeta.textContent = "Module · branch anchor";
            left.appendChild(mTitle);
            left.appendChild(mMeta);

            const right = document.createElement("div");
            const chevron = document.createElement("span");
            chevron.className =
              "module-chevron" + (mod.box.expanded ? " expanded" : "");
            chevron.textContent = "▶";
            right.appendChild(chevron);

            header.appendChild(left);
            header.appendChild(right);
            card.appendChild(header);

            const body = document.createElement("div");
            body.className = "module-body";
            if (!mod.box.expanded) {
              body.style.display = "none";
            }

            const mTa = document.createElement("textarea");
            mTa.className = "module-textarea";
            mTa.value = mod.text || "";
            if (mod.box && mod.box.height) {
              mTa.style.height = mod.box.height + "px";
            }
            mTa.placeholder =
              "Use this module for a specific arc, branch, or responsibility. Lens entries can be routed here from Home.";
            mTa.addEventListener("input", () => {
              mod.text = mTa.value;
              mod.box.height = mTa.clientHeight;
              this.updateField(field);
            });

            const footer = document.createElement("div");
            footer.className = "module-footer";
            const footerHint = document.createElement("div");
            footerHint.className = "module-footer-hint";
            footerHint.textContent =
              field.nextFieldId && field.nextFieldId !== null
                ? "This module already points into the current field chain."
                : "Create the next field in this chain from this module.";
            const branchBtn = document.createElement("button");
            branchBtn.className = "btn btn-primary btn-small";
            branchBtn.textContent = field.nextFieldId
              ? "Go to next field"
              : "Create next field";
            branchBtn.addEventListener("click", () => {
              this.createOrGoToNextField(field.id, mod.id);
            });

            footer.appendChild(footerHint);
            footer.appendChild(branchBtn);

            body.appendChild(mTa);
            body.appendChild(footer);
            card.appendChild(body);

            header.addEventListener("click", () => {
              mod.box.expanded = !mod.box.expanded;
              chevron.classList.toggle("expanded", mod.box.expanded);
              body.style.display = mod.box.expanded ? "block" : "none";
              this.updateField(field);
            });

            modulesPanel.appendChild(card);
          });
        }

        container.appendChild(modulesPanel);

        this.main.innerHTML = "";
        this.main.appendChild(container);
      },

      computeDepth(fieldId) {
        let depth = 1;
        let node = this.getFieldById(fieldId);
        while (node && node.parentFieldId) {
          depth += 1;
          node = this.getFieldById(node.parentFieldId);
        }
        return depth;
      },
    };

    document.addEventListener("DOMContentLoaded", () => {
      App.init();
    });
  </script>
</body>
</html>
